<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡§º ‚Äî MGNREGA (Maharashtra)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f7f7f7;color:#222}
    header{background:#0a62a7;color:#fff;padding:14px 16px;text-align:center}
    .container{padding:12px}
    .big-btn{display:block;width:100%;padding:14px;margin:10px 0;border-radius:10px;border:none;font-size:18px}
    .loc-btn{background:#ffb703;color:#111}
    .card{background:#fff;padding:14px;border-radius:10px;margin:10px 0;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
    .kpi{display:flex;align-items:center;justify-content:space-between}
    .kpi .left{font-size:16px}
    .kpi .value{font-size:28px;font-weight:700}
    .green{color:green}.amber{color:#d48806}.red{color:red}
    .small{font-size:12px;color:#555}
    footer{padding:12px;text-align:center;font-size:13px;color:#666}
    .row{display:flex;gap:8px}
    button.icon{border:none;background:transparent;font-size:18px}
    select{width:100%;padding:14px;font-size:16px;border-radius:8px;border:2px solid #0a62a7;margin:10px 0;background:#fff}
  </style>
</head>
<body>
  <header>
    <div style="font-size:18px">‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡§º ‚Äî MGNREGA (Maharashtra)</div>
    <div style="font-size:12px">‡§∏‡§∞‡§≤, ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§î‡§∞ ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§Æ‡§¶‡§¶</div>
  </header>

  <div class="container">
    <button class="big-btn loc-btn" id="useLocation">üìç ‡§Æ‡•á‡§∞‡•Ä ‡§ú‡§ó‡§π ‡§™‡§π‡§ö‡§æ‡§®‡•ã</button>
    
    <div class="card">
      <label for="districtSelect" style="font-weight:700;display:block;margin-bottom:8px">‡§ú‡§ø‡§≤‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç / Select District:</label>
      <select id="districtSelect"></select>
    </div>
    
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="districtName" style="font-size:18px;font-weight:700">‡§Æ‡•Å‡§Ç‡§¨‡§à</div>
          <div id="lastUpdated" class="small">Last: ‚Äî</div>
        </div>
        <div>
          <button class="icon" id="speakBtn" title="‡§∏‡•Å‡§®‡§ø‡§è">üîä</button>
        </div>
      </div>
    </div>

    <div id="kpis"></div>

    <div class="card">
      <div style="font-weight:700">‡§Æ‡§æ‡§π-‡§¶‡§∞-‡§Æ‡§æ‡§π ‡§∞‡•Å‡§ù‡§æ‡§®</div>
      <div id="timeseries" class="small">(‡§ï‡§æ‡§∞‡•ç‡§° ‡§ü‡•à‡§™ ‡§ï‡§∞ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§¶‡•á‡§ñ‡•á‡§Ç)</div>
    </div>
  </div>

  <footer>
    <span id="ownerName">‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡§º, ‡§π‡§Æ‡§æ‡§∞‡•á ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞</span> ‚Äî MGNREGA ‡§°‡•á‡§ü‡§æ ‡§Æ‡§π‡§æ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è
  </footer>

  <script>
    function speak(text, lang='hi-IN'){
      if(!('speechSynthesis' in window)){
        return;
      }
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = lang;
        u.onerror = function(event){
          console.warn('Speech synthesis error ignored');
        };
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }catch(e){ 
        console.warn('Speech synthesis not available');
      }
    }

    async function loadCache(){
      const r = await fetch('/api/cache');
      if(!r.ok) throw new Error('no cache');
      return r.json();
    }

    function renderKPIs(did, cache){
      const ddata = cache.data[did];
      if(!ddata) return;
      const districtObj = cache.districts.find(d=>d.district_id===did);
      document.getElementById('districtName').innerText = districtObj ? districtObj.name_hi : did;
      document.getElementById('lastUpdated').innerText = '‡§Æ‡§π‡•Ä‡§®‡§æ: ' + ddata.latest_month;
      const kpis = [
        {label:'‡§∞‡•ã‡§ú‡§º‡§ó‡§æ‡§∞ (‡§™‡§ø‡§õ‡§≤‡§æ ‡§Æ‡§æ‡§π)', key:'employment_provided', emoji:'üë∑'},
        {label:'‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® (%)', key:'payments_on_time', emoji:'üí∏'},
        {label:'‡§î‡§∏‡§§ ‡§¶‡•á‡§∞‡•Ä (‡§¶‡§ø‡§®)', key:'avg_payment_delay_days', emoji:'‚è≥'},
        {label:'‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü', key:'active_projects', emoji:'üèóÔ∏è'},
        {label:'‡§∂‡§ø‡§ï‡§æ‡§Ø‡§§‡•á‡§Ç ‡§ñ‡•Å‡§≤‡•Ä', key:'grievances_open', emoji:'üì£'}
      ];
      const container = document.getElementById('kpis');
      container.innerHTML = '';
      kpis.forEach(k=>{
        const val = ddata[k.key];
        const card = document.createElement('div'); card.className='card';
        const html = `<div class="kpi">
          <div class="left">${k.emoji} ${k.label}<div class="small">${k.key}</div></div>
          <div class="value">${val}</div>
        </div>`;
        card.innerHTML = html;
        card.onclick = ()=> showTimeseries(ddata.timeseries);
        container.appendChild(card);
      });

      document.getElementById('speakBtn').onclick = ()=> {
        const txt = `${districtObj.name_hi} ‡§ï‡•á ‡§≤‡§ø‡§è, ${ddata.employment_provided} ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∏‡§Æ‡§Ø ‡§™‡§∞: ${ddata.payments_on_time} ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§‡•§ ‡§î‡§∏‡§§ ‡§¶‡•á‡§∞‡•Ä ${ddata.avg_payment_delay_days} ‡§¶‡§ø‡§®‡•§`;
        speak(txt);
      };
    }

    function showTimeseries(series){
      const el = document.getElementById('timeseries');
      el.innerHTML = '';
      series.slice(0,6).forEach(s=>{
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML = `<div style="font-weight:700">${s.month}</div>
          <div class="small">‡§∞‡•ã‡§ú‡§º‡§ó‡§æ‡§∞: ${s.employment}</div>
          <div class="small">‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®: ${s.payments_on_time}%</div>
          <div class="small">‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§¶‡•á‡§∞‡•Ä: ${s.delay} ‡§¶‡§ø‡§®</div>`;
        el.appendChild(div);
      })
    }

    function nearestDistrict(lat, lon, cache){
      let best = null; let bestDist = 1e9;
      cache.districts.forEach(d=>{
        const [dl, dlng] = d.centroid;
        const dx = dl - lat; const dy = dlng - lon;
        const dist = dx*dx + dy*dy;
        if(dist < bestDist){ bestDist = dist; best = d }
      });
      return best ? best.district_id : cache.districts[0].district_id;
    }

    (async function(){
      let cache = null;
      try{ cache = await loadCache(); } catch(e){ console.error('cache load failed', e); alert('‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ'); return; }
      
      const select = document.getElementById('districtSelect');
      cache.districts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.district_id;
        opt.textContent = `${d.name_hi} (${d.name_en})`;
        select.appendChild(opt);
      });
      
      let selected = 'pune';
      select.value = selected;
      renderKPIs(selected, cache);

      select.onchange = () => {
        selected = select.value;
        renderKPIs(selected, cache);
      };

      document.getElementById('useLocation').onclick = ()=>{
        if(!navigator.geolocation){ alert('‡§∏‡•ç‡§•‡§æ‡§® ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç'); return; }
        navigator.geolocation.getCurrentPosition(pos=>{
          const lat = pos.coords.latitude, lon = pos.coords.longitude;
          const nearest = nearestDistrict(lat, lon, cache);
          selected = nearest;
          select.value = nearest;
          renderKPIs(nearest, cache);
        }, err=>{
          alert('‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä ‡§Ø‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø'); console.log(err);
        }, {timeout:8000});
      }
    })();
  </script>
</body>
</html>
